<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>سامانه ثبت حضور و غیاب</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap');

body {
    margin: 0;
    font-family: 'Vazirmatn', sans-serif;
    background: linear-gradient(180deg, #020024 0%, #090979 35%, #00d4ff 100%);
    color: #fff;
    text-align: center;
    overflow-x: hidden;
}

.hidden {
    display: none;
}

.container {
    padding: 20px;
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.glass-card {
    background: rgba(0, 0, 0, 0.2);
    -webkit-backdrop-filter: blur(10px); /* Safari support */
    backdrop-filter: blur(10px);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    padding: 20px;
    margin: 15px 0;
}

input, button, select, textarea {
    width: 90%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 10px;
    border: none;
    outline: none;
    font-size: 1em;
    font-family: 'Vazirmatn', sans-serif;
}

input, textarea, select {
    background: rgba(0, 0, 0, 0.5);
    color: #fff;
    border: 1px solid rgba(0, 212, 255, 0.5);
    box-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
}

button {
    background: linear-gradient(90deg, #00d4ff, #090979);
    color: white;
    font-weight: bold;
    box-shadow: 0 0 15px #00d4ff;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

button:hover {
    box-shadow: 0 0 25px #00d4ff, 0 0 10px #fff;
    transform: translateY(-2px);
}

h1, h2 {
    color: #fff;
    text-shadow: 0 0 10px #00d4ff, 0 0 5px #fff;
}

.menu-btn {
    display: block;
    width: 100%;
    margin: 12px 0;
    padding: 15px;
    font-size: 1.1em;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0, 212, 255, 0.7);
    animation: slideIn 0.5s forwards;
    opacity: 0;
}

/* Staggered animation for menu buttons */
.menu-btn:nth-child(1) { animation-delay: 0.1s; }
.menu-btn:nth-child(2) { animation-delay: 0.2s; }
.menu-btn:nth-child(3) { animation-delay: 0.3s; }
.menu-btn:nth-child(4) { animation-delay: 0.4s; }
.menu-btn:nth-child(5) { animation-delay: 0.5s; }

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.menu-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: all 0.7s;
}

.menu-btn:hover::before {
    left: 100%;
}

.back-btn {
    background: transparent;
    color: #00d4ff;
    border: 1px solid #00d4ff;
    box-shadow: none;
    margin-top: 15px;
}

.report-item {
    padding: 10px;
    border-bottom: 1px solid rgba(0, 212, 255, 0.4);
    text-align: right;
}

#headerLogo {
    text-align: center;
    margin: 10px 0 20px 0;
}

#headerLogo img {
    height: 60px;
    object-fit: contain;
    filter: drop-shadow(0 0 8px #fff);
}
</style>
</head>
<body>
    <!-- لوگوی بالای همه صفحات -->
<div id="headerLogo">
  <img src="logo.png" alt="لوگو" />
</div>

<!-- صفحه ورود -->
<div id="loginPage" class="container">
<h1>سامانه ثبت حضور و غیاب</h1>
<div class="glass-card">
<input id="username" placeholder="نام کاربری" />
<input id="password" type="password" placeholder="رمز عبور" />
<button onclick="login()">ورود</button>
</div>
</div>

<!-- منوی اصلی -->
<div id="menuPage" class="container hidden">
<h2>منوی اصلی</h2>
<button class="menu-btn" onclick="showPage('eventsPage')">📌 ثبت وقایع</button>
<button class="menu-btn" onclick="showPage('reportsPage')">📑 گزارشات ثبت‌شده</button>
<button class="menu-btn" onclick="showPage('exportPage')">📊 خروجی اکسل / CSV</button>
<button class="menu-btn" onclick="showPage('profilePage')">👤 پروفایل کاربر</button>
<button class="menu-btn" onclick="showPage('logoutPage')">🚪 خروج از سیستم</button>
</div>

<!-- ثبت وقایع -->
<div id="eventsPage" class="container hidden">
<h2>ثبت وقایع</h2>
<div class="glass-card">
<input id="empName" placeholder="نام و نام خانوادگی کارمند" />
<input id="empCode" placeholder="شماره پرسنلی" />
<input id="eventDate" class="persian-date" placeholder="تاریخ شمسی" />
<select id="eventType">
<option value="ورود">ورود</option>
<option value="خروج">خروج</option>
</select>
<input id="eventTime" class="persian-time" placeholder="انتخاب ساعت" />
<textarea id="description" placeholder="توضیحات / دلیل"></textarea>
<button onclick="saveEvent()">ثبت</button>
<button class="back-btn" onclick="backToMenu()">بازگشت</button>
</div>
</div>

<!-- گزارشات -->
<div id="reportsPage" class="container hidden">
<h2>گزارشات ثبت‌شده</h2>
<div class="glass-card">
<input id="searchName" placeholder="نام یا شماره پرسنلی" />
<input id="fromDate" class="persian-date" placeholder="از تاریخ" />
<input id="toDate" class="persian-date" placeholder="تا تاریخ" />
<button onclick="searchReports()">جستجو</button>
<button onclick="exportToExcel()">📥 دانلود اکسل</button>
<div id="reportResults" class="glass-card"></div>
<button class="back-btn" onclick="backToMenu()">بازگشت</button>
</div>
</div>

<!-- خروجی -->
<div id="exportPage" class="container hidden">
  <h2>خروجی</h2>
  <div class="glass-card">
    <select id="exportType">
      <option value="تکی">تکی</option>
      <option value="گروهی">گروهی</option>
    </select>
    <input id="expFrom" class="persian-date" placeholder="از تاریخ" />
    <input id="expTo" class="persian-date" placeholder="تا تاریخ" />
    <input id="expEmp" placeholder="نام یا شماره پرسنلی" />

    <button onclick="exportData('csv')">📄 دانلود CSV</button>
    <button onclick="exportData('excel')">📊 دانلود Excel</button>
    <button class="back-btn" onclick="backToMenu()">بازگشت</button>
  </div>
</div>


<!-- پروفایل -->
<div id="profilePage" class="container hidden">
<h2>پروفایل کاربر</h2>
<div class="glass-card">
<p>👤 نام کاربری: <span id="profileName">عباس</span></p>
<p>🔢 شماره پرسنلی: <span id="profileCode">1335</span></p>
<button>تغییر رمز</button>
<button class="back-btn" onclick="backToMenu()">بازگشت</button>
</div>
</div>

<!-- خروج -->
<div id="logoutPage" class="container hidden">
<h2>خروج از سیستم</h2>
<div class="glass-card">
<p>آیا مایل به خروج هستید؟</p>
<button onclick="logout()">بله</button>
<button class="back-btn" onclick="backToMenu()">خیر</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<script>
const users=[{username:"عباس",password:"1335"}];
let events=[];

function login(){
  const u=document.getElementById("username").value;
  const p=document.getElementById("password").value;
  const user=users.find(x=>x.username===u&&x.password===p);
  if(user){showPage("menuPage");}
  else{alert("نام کاربری یا رمز اشتباه است");}
}

function showPage(id){
  document.querySelectorAll(".container").forEach(p=>p.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  if(id === "eventsPage"){
    // فعال‌سازی انتخاب تاریخ شمسی
    $("#eventDate").persianDatepicker({
      format: 'YYYY/MM/DD',
      autoClose: true,
      initialValue: true
    });

    // فعال‌سازی انتخاب ساعت (شبیه آیفون)
    $("#eventTime").persianDatepicker({
      format: "HH:mm",
      autoClose: true,
      onlyTimePicker: true,
      initialValue: false
    });

    // باز شدن خودکار تقویم تاریخ
    setTimeout(()=>{ $("#eventDate").focus(); }, 300);

    // باز شدن خودکار انتخاب ساعت (بعد از تاریخ)
    setTimeout(()=>{ $("#eventTime").focus(); }, 800);
  }
}
function toEnglishDigits(str){
  if(!str) return "";
  return str.replace(/[۰-۹]/g, d => "۰۱۲۳۴۵۶۷۸۹".indexOf(d));
}




function backToMenu(){showPage("menuPage");}
function normalizeDate(dateStr){
  if(!dateStr) return "";
  // تبدیل اعداد فارسی به انگلیسی
  const eng = toEnglishDigits(dateStr);
  const parts = eng.split("/");
  if(parts.length !== 3) return "";
  const y = parts[0];
  const m = parts[1].padStart(2,"0");
  const d = parts[2].padStart(2,"0");
  return `${y}/${m}/${d}`;
}

function saveEvent(){
  // تاریخ با تبدیل به اعداد انگلیسی
  const date = toEnglishDigits(normalizeDate($("#eventDate").val()));

  const event = {
    name: document.getElementById("empName").value.trim(),
    code: toEnglishDigits(document.getElementById("empCode").value.trim()), // کد پرسنلی هم
    date: date,
    type: document.getElementById("eventType").value,
    time: toEnglishDigits(document.getElementById("eventTime").value.trim()), // ساعت انگلیسی
    desc: document.getElementById("description").value.trim()
  };

  console.log("DEBUG event:", event);

  if(!event.name || !event.code || !event.date || !event.time){
    alert("لطفاً همه فیلدهای ضروری را پر کنید!");
    return;
  }

  events.push(event);
  alert("✅ ثبت شد");

  // پاکسازی فرم
  document.getElementById("empName").value = "";
  document.getElementById("empCode").value = "";
  $("#eventDate").val("");
  document.getElementById("eventTime").value = "";
  document.getElementById("description").value = "";
}




function searchReports(){
  const keyword = document.getElementById("searchName").value.trim().toLowerCase();

  const fromVal = document.getElementById("fromDate").value;
  const toVal   = document.getElementById("toDate").value;

  const fromNum = fromVal ? parseInt(normalizeDate(fromVal)) : 0;
  const toNum   = toVal   ? parseInt(normalizeDate(toVal))   : 99999999;

  const resultsDiv = document.getElementById("reportResults");
  resultsDiv.innerHTML = "";

  const filtered = events.filter(ev => {
    const evNum = parseInt(normalizeDate(ev.date));
    const evName = ev.name ? ev.name.trim().toLowerCase() : "";
    const evCode = ev.code ? ev.code.trim().toLowerCase() : "";

    return (!keyword || evName.includes(keyword) || evCode.includes(keyword)) &&
           (!isNaN(evNum) && evNum >= fromNum && evNum <= toNum);
  });

  if(filtered.length === 0){
    resultsDiv.innerHTML = "<p>❌ موردی یافت نشد</p>";
  } else {
    filtered.forEach((ev, index) => {
      const originalIndex = events.findIndex(e => e === ev);
      resultsDiv.innerHTML += `
        <div class="report-item glass-card" style="margin:8px 0;padding:8px;text-align:right" id="report-${originalIndex}">
          👤 نام: ${ev.name} <br>
          🔢 کد پرسنلی: ${ev.code} <br>
          📅 تاریخ: ${ev.date} <br>
          ⏰ ${ev.type}: ${ev.time} <br>
          📝 توضیح: ${ev.desc} <br>
          <button onclick="viewEvent(${originalIndex})" style="width:auto;padding:5px 10px;font-size:0.8em;margin-top:5px;">👁️ مشاهده</button>
          <button onclick="editEvent(${originalIndex})" style="width:auto;padding:5px 10px;font-size:0.8em;margin-top:5px;">✏️ ویرایش</button>
          <button onclick="deleteEvent(${originalIndex})" style="width:auto;padding:5px 10px;font-size:0.8em;margin-top:5px;background:darkred;color:white;">❌ حذف</button>
        </div>`;
    });
  }

  // ⭐ ذخیره نتایج برای استفاده در exportToExcel
  window.lastSearchResults = filtered;
}


function viewEvent(index) {
  const event = events[index];
  alert(`
    نام: ${event.name}
    کد پرسنلی: ${event.code}
    تاریخ: ${event.date}
    نوع: ${event.type}
    ساعت: ${event.time}
    توضیحات: ${event.desc}
  `);
}

function editEvent(index) {
  const event = events[index];
  
  // Pre-fill the form with the event data
  document.getElementById("empName").value = event.name;
  document.getElementById("empCode").value = event.code;
  $("#eventDate").val(event.date);
  document.getElementById("eventType").value = event.type;
  document.getElementById("eventTime").value = event.time;
  document.getElementById("description").value = event.desc;
  
  // Change the save button to an update button
  const saveButton = document.querySelector("#eventsPage button");
  saveButton.textContent = "بروزرسانی";
  saveButton.onclick = function() {
    updateEvent(index);
  };
  
  showPage('eventsPage');
}

function updateEvent(index) {
  const date = normalizeDate($("#eventDate").val());

  const updatedEvent = {
    name: document.getElementById("empName").value.trim(),
    code: document.getElementById("empCode").value.trim(),
    date: date,
    type: document.getElementById("eventType").value,
    time: document.getElementById("eventTime").value.trim(),
    desc: document.getElementById("description").value.trim()
  };

  if(!updatedEvent.name || !updatedEvent.code || !updatedEvent.date || !updatedEvent.time){
    alert("لطفاً همه فیلدهای ضروری را پر کنید!");
    return;
  }

  events[index] = updatedEvent;
  alert("✅ بروزرسانی شد");

  // Reset the form and save button
  document.getElementById("empName").value = "";
  document.getElementById("empCode").value = "";
  $("#eventDate").val("");
  document.getElementById("eventTime").value = "";
  document.getElementById("description").value = "";
  const saveButton = document.querySelector("#eventsPage button");
  saveButton.textContent = "ثبت";
  saveButton.onclick = saveEvent;

  showPage('reportsPage');
  searchReports(); // Refresh the reports list
}

function deleteEvent(index) {
  if (confirm("آیا از حذف این گزارش مطمئن هستید؟")) {
    events.splice(index, 1);
    alert("✅ حذف شد");
    searchReports(); // Refresh the reports list
  }
}



function logout(){showPage("loginPage");}

// فعال کردن تقویم شمسی
$(function(){
  $(".persian-date").persianDatepicker({format:'YYYY/MM/DD', initialValue:true, autoClose:true});
});
function exportData(format){
  const type = document.getElementById("exportType").value;
  const fromVal = document.getElementById("expFrom").value;
  const toVal   = document.getElementById("expTo").value;
  const keyword = document.getElementById("expEmp").value.trim().toLowerCase();

  const fromNum = fromVal ? parseInt(normalizeDate(fromVal)) : 0;
  const toNum   = toVal   ? parseInt(normalizeDate(toVal))   : 99999999;

  let filtered = events.filter(ev => {
    const evNum = parseInt(normalizeDate(ev.date));
    const evName = ev.name ? ev.name.trim().toLowerCase() : "";
    const evCode = ev.code ? ev.code.trim().toLowerCase() : "";

    // فیلتر بر اساس تکی یا گروهی
    if(type === "تکی" && keyword && !(evName.includes(keyword) || evCode.includes(keyword))){
      return false;
    }

    return (!isNaN(evNum) && evNum >= fromNum && evNum <= toNum);
  });

  if(filtered.length === 0){
    alert("❌ هیچ داده‌ای یافت نشد");
    return;
  }

  let csv = "نام,کد پرسنلی,تاریخ,نوع,ساعت,توضیحات\n";
  filtered.forEach(ev=>{
    csv += `"${ev.name}","${ev.code}","${ev.date}","${ev.type}","${ev.time}","${ev.desc}"\n`;
  });

  const blobType = (format === "excel")
    ? "application/vnd.ms-excel;charset=utf-8;"
    : "text/csv;charset=utf-8;";

  const ext = (format === "excel") ? "xls" : "csv";

  const blob = new Blob(["\uFEFF" + csv], { type: blobType });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `گزارش-حضورغیاب.${ext}`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}
function exportToExcel(){
  // خروجی اکسل بر اساس گزارشات
  if(window.lastSearchResults && window.lastSearchResults.length > 0){
    // فقط داده‌های فیلتر شده
    const filtered = window.lastSearchResults;
    let csv = "نام,کد پرسنلی,تاریخ,نوع,ساعت,توضیحات\n";
    filtered.forEach(ev=>{
      csv += `"${ev.name}","${ev.code}","${ev.date}","${ev.type}","${ev.time}","${ev.desc}"\n`;
    });

    const blob = new Blob(["\uFEFF" + csv], { type: "application/vnd.ms-excel;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "گزارش-حضورغیاب.xls";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } else {
    alert("❌ هیچ گزارشی برای خروجی یافت نشد. لطفاً ابتدا جستجو کنید.");
  }
}






</script>
</body>
</html>
